name: WATCHDOG Complete System

on:
  schedule:
    # Run daily at 2:00 AM UTC (hybrid auto-alternating mode)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'System mode to run'
        required: true
        default: 'hybrid'
        type: choice
        options:
          - 'hybrid'
          - 'original'
          - 'enhanced'
      papers_per_domain:
        description: 'Number of papers per domain'
        required: false
        default: ''
        type: string

env:
  # API Keys - Set these in GitHub Secrets
  OPEN_API: ${{ secrets.OPEN_API }}
  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
  groq_API: ${{ secrets.GROQ_API }}
  cohere_API: ${{ secrets.COHERE_API }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  
  # GitHub Integration
  GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  API_GITHUB: ${{ secrets.API_GITHUB }}
  GITHUB_USER: ${{ github.repository_owner }}
  GITHUB_REPO: 'WATCHDOG_memory'
  
  # System Configuration
  SELECTOR_MIN_SCORE: '3.0'
  WATCHDOG_FINALIZE: '1'
  PYTHONUNBUFFERED: '1'

jobs:
  watchdog-system:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours timeout
    
    steps:
    - name: ðŸš€ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ðŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Dependencies installed"
    
    - name: ðŸ” Determine Execution Mode
      id: mode
      run: |
        if [ "${{ github.event.inputs.mode }}" != "" ]; then
          MODE="${{ github.event.inputs.mode }}"
          echo "ðŸ”§ Manual mode selected: $MODE"
        else
          MODE="hybrid"
          echo "ðŸ”„ Default mode: hybrid (auto-alternating)"
        fi
        echo "mode=$MODE" >> $GITHUB_OUTPUT
        echo "EXECUTION_MODE=$MODE" >> $GITHUB_ENV
    
    - name: ðŸ§¹ Clean Previous Artifacts
      run: |
        if [ -d "artifacts" ]; then
          echo "ðŸ§¹ Cleaning previous artifacts..."
          rm -rf artifacts
          echo "âœ… Previous artifacts cleaned"
        else
          echo "ðŸ“ No previous artifacts to clean"
        fi
    
    - name: ðŸ”„ Run Hybrid System (Auto-Alternating)
      if: env.EXECUTION_MODE == 'hybrid'
      run: |
        echo "ðŸ”„ Running Hybrid WATCHDOG System (Auto-Alternating)"
        echo "ðŸ“… Schedule: 1 day original â†’ 2 days enhanced â†’ repeat"
        echo "â° Started at: $(date)"
        
        python hybrid_watchdog.py pipeline
        
        echo "âœ… Hybrid system completed"
        echo "â° Completed at: $(date)"
    
    - name: ðŸ“Š Run Original System (Broad Coverage)
      if: env.EXECUTION_MODE == 'original'
      run: |
        echo "ðŸ“Š Running Original WATCHDOG System (Broad arXiv Coverage)"
        echo "ðŸŽ¯ Target: ${{ github.event.inputs.papers_per_domain || '2' }} papers per domain"
        echo "â° Started at: $(date)"
        
        # Run original pipeline components
        echo "ðŸ“¡ Step 1: Original arXiv Scraping"
        python scraper.py
        
        echo "ðŸ“„ Step 2: PDF Text Extraction"
        python extractor.py
        
        echo "ðŸŽ¯ Step 3: Paper Selection"
        python selector.py
        
        echo "ðŸ“‹ Step 4: Project Planning"
        python planner.py
        
        echo "ðŸ¤– Step 5: Multi-Agent Implementation"
        if [ -d "artifacts/structures" ]; then
          for project_dir in artifacts/structures/*/; do
            if [ -d "$project_dir" ]; then
              project_name=$(basename "$project_dir")
              echo "ðŸ”§ Implementing project: $project_name"
              python manager.py "$project_name" || echo "âš ï¸ Project $project_name failed"
            fi
          done
        else
          echo "âŒ No project structures found"
        fi
        
        echo "âœ… Original system completed"
        echo "â° Completed at: $(date)"
    
    - name: ðŸš€ Run Enhanced System (AI/ML Specialized)
      if: env.EXECUTION_MODE == 'enhanced'
      run: |
        echo "ðŸš€ Running Enhanced WATCHDOG System (AI/ML Specialized)"
        echo "ðŸŽ¯ Focus: RAG, NLP, Agents, MLOps, Computer Vision"
        echo "ðŸ“Š Target: ${{ github.event.inputs.papers_per_domain || '3' }} papers per domain"
        echo "â° Started at: $(date)"
        
        python enhanced_watchdog.py pipeline ${{ github.event.inputs.papers_per_domain || '3' }}
        
        echo "âœ… Enhanced system completed"
        echo "â° Completed at: $(date)"
    
    - name: ðŸ“Š Generate Execution Summary
      if: always()
      run: |
        echo "ðŸ“Š Generating WATCHDOG Execution Summary..."
        
        # Create summary report
        cat > execution_summary.md << EOF
        # ðŸ¤– WATCHDOG System Execution Summary
        
        **Execution Time:** $(date)
        **Repository:** ${{ github.repository }}
        **Mode:** ${{ env.EXECUTION_MODE }}
        **Workflow Run:** ${{ github.run_id }}
        
        ## ðŸ“Š System Configuration
        - **Mode**: ${{ env.EXECUTION_MODE }}
        - **Papers per Domain**: ${{ github.event.inputs.papers_per_domain || 'default' }}
        - **Trigger**: ${{ github.event_name }}
        
        ## ðŸ“ Generated Artifacts
        EOF
        
        if [ -d "artifacts" ]; then
          echo "### Artifact Counts:" >> execution_summary.md
          echo "- ðŸ“„ PDFs: $(find artifacts -name "*.pdf" 2>/dev/null | wc -l)" >> execution_summary.md
          echo "- ðŸ“ Text Chunks: $(find artifacts -name "*.txt" 2>/dev/null | wc -l)" >> execution_summary.md
          echo "- âœ… Relevant Papers: $(find artifacts/relevant -type d -mindepth 1 2>/dev/null | wc -l)" >> execution_summary.md
          echo "- ðŸ“‹ Project Plans: $(find artifacts/structures -name "*.json" 2>/dev/null | wc -l)" >> execution_summary.md
          echo "- ðŸš€ Generated Projects: $(find artifacts/projects -type d -mindepth 1 2>/dev/null | wc -l)" >> execution_summary.md
          
          echo "### Directory Structure:" >> execution_summary.md
          echo '```' >> execution_summary.md
          find artifacts -type f | head -20 >> execution_summary.md
          if [ $(find artifacts -type f | wc -l) -gt 20 ]; then
            echo "... and $(( $(find artifacts -type f | wc -l) - 20 )) more files" >> execution_summary.md
          fi
          echo '```' >> execution_summary.md
        else
          echo "âŒ No artifacts directory found" >> execution_summary.md
        fi
        
        # Add mode-specific information
        if [ "${{ env.EXECUTION_MODE }}" = "hybrid" ]; then
          echo "## ðŸ”„ Hybrid Mode Information" >> execution_summary.md
          if [ -f "hybrid_mode_config.json" ]; then
            echo '```json' >> execution_summary.md
            cat hybrid_mode_config.json >> execution_summary.md
            echo '```' >> execution_summary.md
          fi
        fi
        
        echo "ðŸ“Š Summary report generated"
    
    - name: ðŸ“¤ Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: watchdog-artifacts-${{ env.EXECUTION_MODE }}-${{ github.run_id }}
        path: |
          artifacts/
          execution_summary.md
          hybrid_mode_config.json
        retention-days: 30
    
    - name: ðŸ’¾ Finalize and Backup
      if: success()
      run: |
        echo "ðŸ’¾ Finalizing WATCHDOG execution..."
        echo "âœ… All artifacts and projects automatically synced to WATCHDOG_memory repository"
        echo "ðŸš€ Individual project repositories created and populated"
        echo "ðŸ“Š Execution completed successfully"
    
    - name: ðŸ”” Handle Failure
      if: failure()
      run: |
        echo "âŒ WATCHDOG execution failed"
        echo "ðŸ” Check the logs above for error details"
        echo "ðŸ“Š Partial results may still be available in artifacts"
        
        # Create failure report
        echo "# âŒ WATCHDOG Failure Report" > failure_report.md
        echo "**Time:** $(date)" >> failure_report.md
        echo "**Mode:** ${{ env.EXECUTION_MODE }}" >> failure_report.md
        echo "**Repository:** ${{ github.repository }}" >> failure_report.md
        echo "**Run ID:** ${{ github.run_id }}" >> failure_report.md
    
    - name: ðŸ“Š Final Status
      if: always()
      run: |
        echo "ðŸ“Š Final WATCHDOG Status:"
        echo "â° Execution completed at: $(date)"
        echo "ðŸ”„ Mode executed: ${{ env.EXECUTION_MODE }}"
        echo "ðŸ“ Artifacts:"
        if [ -d "artifacts" ]; then
          du -sh artifacts/ 2>/dev/null || echo "Could not calculate size"
          echo "ðŸ“Š Total files: $(find artifacts -type f 2>/dev/null | wc -l)"
        else
          echo "No artifacts directory"
        fi
        echo "âœ… WATCHDOG execution summary complete"